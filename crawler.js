// Load the http module to create an http server.                                                                                                                                                                      \
                                                                                                                                                                                                                        
var http = require('http');

// var stockCodes = ['600000' '600005' '600008' '600009' '600010' '600011' '600015' '600016' '600018' '600019' '600022' '600027' '600028' '600029' '600030' '600031' '600036' '600037' '600038' '600039' '600048' '600050' '600056' '600058' '600059' '600060' '600062' '600063' '600066' '600067' '600068' '600072' '600077' '600078' '600079' '600085' '600086' '600089' '600094' '600096' '600100' '600104' '600107' '600108' '600109' '600110' '600111' '600113' '600115' '600116' '600118' '600119' '600120' '600123' '600125' '600132' '600138' '600139' '600141' '600143' '600145' '600146' '600149' '600150' '600151' '600153' '600157' '600158' '600160' '600161' '600163' '600166' '600169' '600170' '600175' '600176' '600177' '600179' '600185' '600186' '600187' '600188' '600193' '600196' '600197' '600198' '600199' '600200' '600206' '600208' '600209' '600216' '600218' '600219' '600221' '600223' '600225' '600228' '600229' '600230' '600239' '600240' '600251' '600252' '600256' '600257' '600259' '600260' '600261' '600266' '600267' '600271' '600276' '600277' '600285' '600288' '600289' '600292' '600293' '600298' '600300' '600309' '600311' '600312' '600315' '600316' '600318' '600321' '600325' '600329' '600332' '600333' '600336' '600340' '600348' '600352' '600354' '600362' '600366' '600369' '600372' '600373' '600375' '600376' '600383' '600387' '600388' '600389' '600390' '600392' '600395' '600406' '600408' '600410' '600415' '600418' '600422' '600425' '600426' '600433' '600435' '600436' '600446' '600449' '600456' '600458' '600460' '600467' '600470' '600478' '600481' '600483' '600486' '600489' '600490' '600491' '600495' '600497' '600498' '600499' '600502' '600503' '600515' '600516' '600517' '600518' '600519' '600521' '600522' '600528' '600535' '600537' '600543' '600545' '600546' '600547' '600549' '600551' '600557' '600559' '600566' '600568' '600570' '600572' '600580' '600582' '600583' '600584' '600585' '600588' '600594' '600596' '600597' '600598' '600600' '600601' '600606' '600609' '600611' '600614' '600616' '600620' '600624' '600633' '600636' '600637' '600640' '600642' '600643' '600644' '600645' '600648' '600649' '600654' '600655' '600660' '600663' '600664' '600667' '600668' '600674' '600675' '600684' '600688' '600690' '600692' '600694' '600696' '600699' '600702' '600703' '600705' '600711' '600718' '600720' '600728' '600739' '600740' '600741' '600742' '600743' '600744' '600747' '600748' '600750' '600751' '600756' '600757' '600759' '600765' '600770' '600771' '600773' '600779' '600783' '600787' '600795' '600797' '600800' '600801' '600802' '600804' '600805' '600807' '600809' '600811' '600815' '600816' '600820' '600823' '600825' '600827' '600830' '600831' '600832' '600835' '600837' '600838' '600839' '600844' '600846' '600851' '600863' '600867' '600868' '600872' '600874' '600875' '600879' '600880' '600881' '600884' '600886' '600887' '600893' '600895' '600900' '600967' '600970' '600971' '600976' '600987' '600993' '600999' '601001' '601002' '601005' '601006' '601009' '601012' '601038' '601088' '601098' '601099' '601101' '601111' '601117' '601118' '601139' '601158' '601166' '601168' '601169' '601186' '601216' '601231' '601238' '601288' '601299' '601311' '601318' '601328' '601333' '601336' '601377' '601388' '601390' '601398' '601519' '601555' '601600' '601601' '601607' '601608' '601618' '601628' '601633' '601666' '601668' '601669' '601688' '601699' '601717' '601766' '601788' '601789' '601800' '601801' '601808' '601818' '601857' '601866' '601886' '601888' '601898' '601899' '601901' '601918' '601928' '601929' '601933' '601939' '601958' '601988' '601989' '601991' '601992' '601996' '601998' '603000'];

var stockCodes = ['600609', '600611', '600614', '600616', '600620', '600624', '600633', '600636', '600637', '600640', '600642', '600643', '600644', '600645', '600648'];
var prevStockInfo = [];
prevStockInfo.length = stockCodes.length;

var mongoose = require('mongoose');
mongoose.connect('mongodb://localhost/sina_data');

var StockModel = mongoose.model('Stock',{"_id":String, "data":Array});


function arraysIdentical(a, b) {
    if (!a || ! b) return false;
    var i = a.length;
    if (i != b.length) return false;
    while (i--) {
        if (a[i] !== b[i]) return false;
    }
    return true;
};

function getStockInfo(i) {

    var stockName = 'sh'+stockCodes[i]

    var options = {
        host: 'hq.sinajs.cn',
        port: 80,
        path: '/list='+stockName
    };


    http.get(options, function(res) {
        res.on('data', function(chunk) {
            eval(chunk.toString());
            var stockNameVar = eval("hq_str_"+stockName);
            var stockInfoArray = stockNameVar.split(",");
            if (arraysIdentical(stockInfoArray,prevStockInfo[i])) {
                console.log("identical "+stockName);
            } else {
                console.log("writing to DB "+stockName);
                //write to DB                                                                                                                                                                                           
                var stock = new StockModel({"_id":stockName+"_"+stockInfoArray[stockInfoArray.length-3]+"_"+stockInfoArray[stockInfoArray.length-2],"data":stockInfoArray});
                stock.save(function (err) {
                    if (err) console.log(err);
                    console.log('inserted');
                });

                prevStockInfo[i] = stockInfoArray;
            }
    });
}).on("error", function(e) {
    console.log("got error" + e.message);
    });
}

function computeKDJ() {
    // get stock data for a particular duration
}

int i = 0;
while (i < 4) {
    getStockInfo(i%15);
    i ++;
}